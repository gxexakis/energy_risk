<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title></title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.26.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.26.0/mapbox-gl.css' rel='stylesheet' />

    <link href='stylesheets/style_riskmapping.css' rel='stylesheet' type='text/css' />
    <link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css' />

</head>
<body>

<div id='map'></div>
<div class='map-overlay'>
    <div id="intro">
        <h2>Sample Riskmeter</h2>
        <p> Welcome! You can click on the symbols in the map to explore the risk of various electricity producing facilities.</p>
    </div> 
    <div id="station_info">
        <h3>Facility information</h3>
        <ul>
            <li id="name">name: -</li>
            <li id="type">type: -</li>
            <li id="power">power (MW): -</li>
            <li id="stations">stations #:</li>
        </ul>
    </div>
    <div id="environmental_risks">
        <h3>Environmental risks</h3>
        <ul id="env_list"></ul>
    </div>
    <div id="social_risks">
        <h3>Social risks</h3>
        <ul id="soc_list"></ul>
    </div>
    <div id="references">
        <h4>References</h4>
        <ul>
            <li>Data source: <a href="https://www.dei.gr/en/i-dei/i-etairia/tomeis-drastiriotitas/paragwgi/analutikos-xartis-stathmwn">Public Power Corporation S.A.-Hellas</a></li>
            <li>Risk source: <a href="https://www.home.barclays/content/dam/barclayspublic/docs/Citizenship/power-generation-guidance-note.pdf">Barclays - Power generation guidance</a></li>
        </ul>
    </div>
</div>

<script>

    // Create the map and center it in country o choice (lat,long)
    mapboxgl.accessToken = 'pk.eyJ1IjoiZ3hleGFraXMiLCJhIjoiY2l1cTF0ejYyMDAybjJ0bno0eW9xc2xoaCJ9.ZJSNBZU45LFx-dsyS9A_yw';
    var map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/gxexakis/civasjaaj005i2imrhhm4b2e5',
        center: [23.801414, 38.292803],
        zoom: 5.8
    });

    map.on('load', function() {

        var label_number = 0

        map.on('click', function (e) {
            var features = map.queryRenderedFeatures(e.point, { layers: ['largest-energy-stations'] });
            // if there are features within the given radius of the click event,
            if (features.length) {

                // fly to the location of the click event
                map.easeTo({
                    center: features[0].geometry.coordinates,
                    zoom: 10,
                    duration: 1000
                });


                // fill the sidebar with the respective information
                document.getElementById('name').innerHTML = 'name: <strong>'+features[0].properties.name+'</strong>';
                document.getElementById('type').innerHTML = 'type: <strong>'+features[0].properties.type+'</strong>';
                document.getElementById('power').innerHTML = 'power (MW): <strong>'+features[0].properties.power_mwatt+'</strong>';
                document.getElementById('stations').innerHTML = 'stations #: <strong>'+features[0].properties.stations_number+'</strong>';

                if (features[0].properties.type=="thermal power station") {

                    document.getElementById('env_list').innerHTML = '\
                        <li>Pressure on natural resources.</li>\
                        <li>Liquid waste.</li>\
                        <li>Solid waste.</li>\
                        <li>Pollutants (VOC, NOX, SOX, PM10, CO, CO2, etc).</li>\
                        <li>Greenhouse gas production.</li>\
                        <li>Dust and noise.</li>\
                        ';

                    document.getElementById('soc_list').innerHTML = '\
                        <li>Community health and safety.</li>\
                        <li>Strain on infrastructure and public nuisance.</li>\
                        ';

                } else if (features[0].properties.type=="hydroelectric power station") {

                }

                // add an effect radius effect
                if (map.getLayer("effect_radius")) {
                    map.removeSource("effect_center");
                    map.removeLayer("effect_radius");
                    if (label_number) {
                        for (var i = 0; i < label_number; i++) {
                            map.removeSource('selectedLabel'+i)
                            map.removeLayer('selectedLabel'+i)
                        }
                    }
                }

                map.addSource("effect_center", {
                    "type": "geojson",
                    "data": {
                      "type": "FeatureCollection",
                      "features": [{
                        "type": "Feature",
                        "geometry": {
                          "type": "Point",
                          "coordinates": features[0].geometry.coordinates
                        } 
                      }]
                    }
                });

                var radiusInMeters = 20000
                const metersToPixelsAtMaxZoom = (meters, latitude) =>
                    meters / 0.075 / Math.cos(latitude * Math.PI / 180)

                map.addLayer({
                    "id": "effect_radius",
                    "type": "circle",
                    "source": "effect_center",
                    "paint": {
                      "circle-radius": {
                        stops: [
                          [0, 0],
                          [20, metersToPixelsAtMaxZoom(radiusInMeters, 
                            features[0].geometry.coordinates[1])]
                        ],
                        base: 2
                      },
                      "circle-color": "red",
                      "circle-opacity": 0.6
                    } 
                });

                map.setLayoutProperty("place_label_city", 'visibility', 'visible')
                map.setLayoutProperty("place_label_town", 'visibility', 'visible')
                map.setLayoutProperty("place_label_village", 'visibility', 'visible')
                map.setLayoutProperty("place_label_other", 'visibility', 'visible')



                // Highlight place labels

                // var wasLoaded = false;
                // map.on('render', function() {
                //     if (!map.loaded() || wasLoaded) return;
                //     var label_features = map.queryRenderedFeatures(
                //         [
                //           [e.point.x - 165, e.point.y - 165],
                //           [e.point.x + 165, e.point.y + 165]
                //         ],{layers:['place_label_city','place_label_town',
                //         'place_label_village','place_label_other']});
                //     wasLoaded = true;

                //     if (!label_features.length) {return;}

                //     label_number = label_features.length;
                //     for (var i = 0; i < label_features.length; i++) {
                //         var original_layout = label_features[i].layer.layout;
                //         var original_paint = label_features[i].layer.paint;
                //         original_paint["text-opacity"] = 1

                //         map.addSource('selectedLabel'+i, {
                //             "type":"geojson",
                //             "data": label_features[i].toJSON()
                //         });

                //         map.addLayer({
                //             "id": "selectedLabel"+i,
                //             "type": "symbol",
                //             "source": "selectedLabel"+i,
                //             "layout": original_layout,
                //             "paint": original_paint
                //         });
                //     }

                // });

            };

            })





        map.on('mousemove', function (e) {
            var features = map.queryRenderedFeatures(e.point, { layers: ['largest-energy-stations']});
            map.getCanvas().style.cursor = (features.length) ? 'pointer' : '';
        });

    });

</script>

</body>
</html>
